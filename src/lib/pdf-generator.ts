'use client';

import { UnifiedReport } from './report-service';
import { AIVerdict } from './gemini';

interface PDFOptions {
    report: UnifiedReport;
    verdict?: AIVerdict | null;
    locale: string;
}

const LABELS: Record<string, Record<string, string>> = {
    ro: {
        title: 'Raport Oficial VYN.md',
        subtitle: 'Raport de Verificare Autovehicul',
        vin: 'Cod VIN',
        generated: 'Generat la',
        specs: 'SpecificaÈ›ii Tehnice',
        national: 'Date Registru NaÈ›ional (RM)',
        history: 'Istoricul Vehiculului',
        aiVerdict: 'Verdict AI â€” VYN Consultant',
        rating: 'Evaluare',
        confidence: 'Ãncredere Ã®n date',
        recommendation: 'Recomandare',
        keyPoints: 'Puncte cheie',
        noNational: 'Vehiculul nu este Ã®nregistrat Ã®n baza de date RM.',
        noHistory: 'Nu existÄƒ evenimente Ã®nregistrate.',
        green: 'ğŸŸ¢ SIGUR',
        yellow: 'ğŸŸ¡ NECESITÄ‚ VERIFICARE',
        red: 'ğŸ”´ EVITAÈšI',
        footer: 'Raport generat de VYN.md â€¢ vyn-three.vercel.app â€¢ Toate drepturile rezervate',
        inspections: 'InspecÈ›ii Tehnice',
        border: 'Treceri FrontierÄƒ',
        status: 'Status',
        mileage: 'Kilometraj',
        date: 'Data',
        result: 'Rezultat',
        point: 'Punct',
        direction: 'DirecÈ›ie',
        entry: 'Intrare',
        exit: 'IeÈ™ire',
    },
    en: {
        title: 'VYN.md Official Report',
        subtitle: 'Vehicle History Report',
        vin: 'VIN Code',
        generated: 'Generated on',
        specs: 'Technical Specifications',
        national: 'National Registry Data (MD)',
        history: 'Vehicle History',
        aiVerdict: 'AI Verdict â€” VYN Consultant',
        rating: 'Rating',
        confidence: 'Data Confidence',
        recommendation: 'Recommendation',
        keyPoints: 'Key Points',
        noNational: 'Vehicle not found in MD national registry.',
        noHistory: 'No recorded events found.',
        green: 'ğŸŸ¢ SAFE',
        yellow: 'ğŸŸ¡ NEEDS INSPECTION',
        red: 'ğŸ”´ AVOID',
        footer: 'Report generated by VYN.md â€¢ vyn-three.vercel.app â€¢ All rights reserved',
        inspections: 'Technical Inspections',
        border: 'Border Crossings',
        status: 'Status',
        mileage: 'Mileage',
        date: 'Date',
        result: 'Result',
        point: 'Point',
        direction: 'Direction',
        entry: 'Entry',
        exit: 'Exit',
    },
    ru: {
        title: 'ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ VYN.md',
        subtitle: 'ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ',
        vin: 'VIN-ĞºĞ¾Ğ´',
        generated: 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½',
        specs: 'Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸',
        national: 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€ĞµĞµÑÑ‚Ñ€Ğ° (Ğ Ğœ)',
        history: 'Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ',
        aiVerdict: 'Ğ’ĞµÑ€Ğ´Ğ¸ĞºÑ‚ Ğ˜Ğ˜ â€” VYN ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚',
        rating: 'ĞÑ†ĞµĞ½ĞºĞ°',
        confidence: 'Ğ”Ğ¾ÑÑ‚Ğ¾Ğ²ĞµÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…',
        recommendation: 'Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ',
        keyPoints: 'ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹',
        noNational: 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ñ€ĞµĞµÑÑ‚Ñ€Ğµ Ğ Ğœ.',
        noHistory: 'Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ½ĞµÑ‚.',
        green: 'ğŸŸ¢ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ',
        yellow: 'ğŸŸ¡ Ğ¢Ğ Ğ•Ğ‘Ğ£Ğ•Ğ¢ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜',
        red: 'ğŸ”´ Ğ˜Ğ—Ğ‘Ğ•Ğ“ĞĞ™Ğ¢Ğ•',
        footer: 'ĞÑ‚Ñ‡Ñ‘Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ VYN.md â€¢ vyn-three.vercel.app â€¢ Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹',
        inspections: 'Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ñ‹',
        border: 'ĞŸĞµÑ€ĞµÑĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹',
        status: 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ',
        mileage: 'ĞŸÑ€Ğ¾Ğ±ĞµĞ³',
        date: 'Ğ”Ğ°Ñ‚Ğ°',
        result: 'Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚',
        point: 'ĞŸÑƒĞ½ĞºÑ‚',
        direction: 'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ',
        entry: 'Ğ’ÑŠĞµĞ·Ğ´',
        exit: 'Ğ’Ñ‹ĞµĞ·Ğ´',
    },
};

function getLabel(locale: string, key: string): string {
    const lang = LABELS[locale] || LABELS['ro'];
    return lang[key] || LABELS['ro'][key] || key;
}

function getRatingLabel(locale: string, rating: 'green' | 'yellow' | 'red'): string {
    return getLabel(locale, rating);
}

export async function generatePDFReport({ report, verdict, locale }: PDFOptions): Promise<void> {
    // Dynamic import to avoid SSR issues
    const jsPDF = (await import('jspdf')).default;

    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = 210;
    const pageH = 297;
    const margin = 18;
    const contentW = pageW - margin * 2;
    let y = 0;

    const L = (key: string) => getLabel(locale, key);

    // â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BLUE = [37, 99, 235] as [number, number, number];
    const DARK = [15, 23, 42] as [number, number, number];
    const GRAY = [100, 116, 139] as [number, number, number];
    const LIGHT = [248, 250, 252] as [number, number, number];
    const WHITE: [number, number, number] = [255, 255, 255];
    const GREEN = [16, 185, 129] as [number, number, number];
    const YELLOW = [245, 158, 11] as [number, number, number];
    const RED = [239, 68, 68] as [number, number, number];

    function addPage() {
        doc.addPage();
        y = margin;
        // Page footer
        doc.setFontSize(7);
        doc.setTextColor(...GRAY);
        doc.text(L('footer'), pageW / 2, pageH - 8, { align: 'center' });
        doc.text(`${report.vin}`, margin, pageH - 8);
    }

    function checkPageBreak(needed: number) {
        if (y + needed > pageH - 20) {
            addPage();
        }
    }

    function sectionHeader(title: string, color: [number, number, number] = BLUE) {
        checkPageBreak(14);
        doc.setFillColor(...color);
        doc.roundedRect(margin, y, contentW, 10, 2, 2, 'F');
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...WHITE);
        doc.text(title.toUpperCase(), margin + 4, y + 6.5);
        y += 14;
    }

    function row(label: string, value: string, shade = false) {
        checkPageBreak(8);
        if (shade) {
            doc.setFillColor(...LIGHT);
            doc.rect(margin, y, contentW, 7, 'F');
        }
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...GRAY);
        doc.text(label, margin + 3, y + 4.5);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...DARK);
        doc.text(String(value), margin + 70, y + 4.5);
        y += 7;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEADER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    doc.setFillColor(...DARK);
    doc.rect(0, 0, pageW, 50, 'F');

    // Blue accent bar
    doc.setFillColor(...BLUE);
    doc.rect(0, 0, 6, 50, 'F');

    // Logo text
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...WHITE);
    doc.text('VYN.md', margin, 20);

    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(148, 163, 184);
    doc.text(L('subtitle').toUpperCase(), margin, 28);

    // VIN badge
    doc.setFillColor(...BLUE);
    doc.roundedRect(margin, 33, contentW, 11, 2, 2, 'F');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...WHITE);
    doc.text(`${L('vin')}: ${report.vin}`, margin + 4, 40.5);

    // Date top-right
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(148, 163, 184);
    const dateStr = new Date().toLocaleDateString(locale === 'ru' ? 'ru-RU' : locale === 'en' ? 'en-GB' : 'ro-RO', {
        day: '2-digit', month: 'long', year: 'numeric'
    });
    doc.text(`${L('generated')}: ${dateStr}`, pageW - margin, 12, { align: 'right' });

    y = 58;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VEHICLE IDENTITY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...DARK);
    doc.text(`${report.year} ${report.make} ${report.model}`, margin, y);
    y += 10;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI VERDICT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (verdict) {
        checkPageBreak(50);
        const verdictColor = verdict.rating === 'green' ? GREEN : verdict.rating === 'red' ? RED : YELLOW;
        const verdictLabel = getRatingLabel(locale, verdict.rating);

        doc.setFillColor(...verdictColor);
        doc.roundedRect(margin, y, contentW, 40, 3, 3, 'F');

        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...WHITE);
        doc.text(L('aiVerdict'), margin + 5, y + 9);

        doc.setFontSize(14);
        doc.text(verdictLabel, margin + 5, y + 19);

        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        const summaryLines = doc.splitTextToSize(verdict.summary, contentW - 10);
        doc.text(summaryLines.slice(0, 2), margin + 5, y + 27);

        doc.setFont('helvetica', 'bold');
        doc.text(`${L('confidence')}: ${verdict.confidence}%`, pageW - margin - 5, y + 9, { align: 'right' });

        y += 46;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SPECS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    sectionHeader(L('specs'));
    const specsEntries = Object.entries(report.specs);
    specsEntries.forEach(([key, value], i) => {
        row(key, String(value), i % 2 === 0);
    });
    y += 4;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NATIONAL DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    checkPageBreak(20);
    sectionHeader(L('national'), [5, 150, 105]);

    if (report.nationalData) {
        const v = report.nationalData.vehicle;
        if (v) {
            row(L('status'), v.Status || 'N/A', true);
            row('Marca', v.Brand || 'N/A', false);
            row('Model', v.Model || 'N/A', true);
            row('Culoare', v.Color || 'N/A', false);
        }

        if (report.nationalData.inspections?.length > 0) {
            y += 4;
            checkPageBreak(10);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...GRAY);
            doc.text(L('inspections').toUpperCase(), margin, y);
            y += 5;

            report.nationalData.inspections.forEach((ins: any, i: number) => {
                row(ins.Date, `${ins.Result} â€” ${ins.Mileage} km`, i % 2 === 0);
            });
        }

        if (report.nationalData.borderCrossings?.length > 0) {
            y += 4;
            checkPageBreak(10);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...GRAY);
            doc.text(L('border').toUpperCase(), margin, y);
            y += 5;

            report.nationalData.borderCrossings.forEach((b: any, i: number) => {
                const dir = b.Direction === 'ENTRY' ? L('entry') : L('exit');
                row(b.DateTime?.split(' ')[0] || '', `${b.Point} â€” ${dir}`, i % 2 === 0);
            });
        }
    } else {
        checkPageBreak(10);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(...GRAY);
        doc.text(L('noNational'), margin + 3, y + 4);
        y += 10;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI KEY POINTS & RECOMMENDATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (verdict && verdict.keyPoints?.length > 0) {
        checkPageBreak(30);
        sectionHeader(L('keyPoints'), [99, 102, 241]);

        verdict.keyPoints.forEach((point, i) => {
            checkPageBreak(8);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...DARK);
            if (i % 2 === 0) {
                doc.setFillColor(...LIGHT);
                doc.rect(margin, y, contentW, 7, 'F');
            }
            doc.text(`â€¢ ${point}`, margin + 3, y + 4.5, { maxWidth: contentW - 6 });
            y += 7;
        });

        y += 4;
        checkPageBreak(16);
        doc.setFillColor(239, 246, 255);
        doc.roundedRect(margin, y, contentW, 14, 2, 2, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...BLUE);
        doc.text(L('recommendation').toUpperCase() + ':', margin + 4, y + 5.5);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...DARK);
        const recLines = doc.splitTextToSize(verdict.recommendation, contentW - 8);
        doc.text(recLines.slice(0, 2), margin + 4, y + 10.5);
        y += 18;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HISTORY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (report.history.length > 0) {
        checkPageBreak(20);
        sectionHeader(L('history'), [71, 85, 105]);

        report.history.forEach((event: any, i: number) => {
            checkPageBreak(8);
            if (i % 2 === 0) {
                doc.setFillColor(...LIGHT);
                doc.rect(margin, y, contentW, 7, 'F');
            }
            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...GRAY);
            doc.text(event.date || '', margin + 3, y + 4.5);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...DARK);
            doc.text(event.description || '', margin + 35, y + 4.5, { maxWidth: contentW - 38 });
            y += 7;
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FOOTER on last page
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    doc.setFontSize(7);
    doc.setTextColor(...GRAY);
    doc.text(L('footer'), pageW / 2, pageH - 8, { align: 'center' });
    doc.text(report.vin, margin, pageH - 8);

    // Save
    const fileName = `VYN-Report-${report.vin}-${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
}
